{{define "content"}}
<h1>Join Requests</h1>

<div id="message" style="margin-bottom: 1em; font-weight: bold;"></div>

<table border="1" cellpadding="6">
  <thead>
    <tr>
      <th>Username</th>
      <th>Name</th>
      <th>Email</th>
      <th>Auto Join</th>
      <th>Status</th>
      <th>Action</th>
    </tr>
  </thead>
  <tbody id="requestsTable">
    {{range .JoinRequests}}
    <tr id="row-{{.Id}}">
      <td>{{.Username}}</td>
      <td>{{.Name}}</td>
      <td>{{.Email}}</td>
      <td>{{.Autojoin}}</td>
      <td class="status">
        {{if eq .Status 0}}Started{{else if eq .Status 1}}Pending{{else if eq .Status 2}}Approved{{else if eq .Status -1}}Denied{{else}}Unknown{{end}}
      </td>
      <td class="actions">
        {{if eq .Status 1}}
        <button onclick="submitAction('{{.Id}}', 'approve')">✅ Approve</button>
        <button onclick="submitAction('{{.Id}}', 'deny')">❌ Deny</button>
        {{end}}
      </td>
    </tr>
    {{end}}
  </tbody>
</table>

<script>
  async function submitAction(id, action) {
    const url = action === 'approve' ? '/join-approve' : '/join-deny';
    try {
      const response = await fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ id })
      });

      if (!response.ok) {
        const text = await response.text();
        throw new Error(`Server error: ${text}`);
      }

      const result = await response.json();
      showMessage(`✅ ${action.charAt(0).toUpperCase() + action.slice(1)} successful for ID: ${id}`, true);

      // Update status and remove buttons
      const row = document.getElementById(`row-${id}`);
      row.querySelector('.status').textContent = action === 'approve' ? 'Approved' : 'Denied';
      row.querySelector('.actions').innerHTML = '';

    } catch (error) {
      showMessage(`❌ Failed to ${action} ID: ${id}. ${error.message}`, false);
    }
  }

  function showMessage(msg, success) {
    const div = document.getElementById('message');
    div.textContent = msg;
    div.style.color = success ? 'green' : 'red';

    // Clear after 5 seconds
    setTimeout(() => {
      div.textContent = '';
    }, 5000);
  }
</script>
{{end}}
