{{define "title"}}Extensions{{end}}
{{define "content"}}
<h1>Extensions</h1>

<div style="margin-bottom:10px;">
  <a href="/addextension">Add Extension</a>
  &nbsp;|&nbsp;
  <a href="/reload" onclick="return confirm('Reload now? This will apply config changes.');">Reload</a>
</div>

<table border="1" cellpadding="5" cellspacing="0">
  <tr>
    <th>Number</th>
    <th>Display Name</th>
    <th>Public</th>
    <th>Status</th>
    <th>Contacts</th>
    <th>Actions</th>
  </tr>
  {{range .}}
  <tr>
    <td>{{.Number}}</td>
    <td>{{.Displayname}}</td>
    <td>{{.Public}}</td>
    <td>{{.Status}}</td>
    <td>{{.Contacts}}</td>
    <td>
      <a href="/editextension?number={{.Number}}">Edit</a> | 
      <a class="delete-link" href="/deleteextension?number={{.Number}}">Delete</a>
    </td>
  </tr>
  {{end}}
</table>

<!-- Progress overlay -->
<div id="busyOverlay" style="
  position:fixed; inset:0; display:none; align-items:center; justify-content:center;
  background:rgba(0,0,0,0.35); z-index:9999;">
  <div style="
    background:#fff; padding:16px 20px; border-radius:12px; min-width:260px;
    display:flex; align-items:center; gap:12px; font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;">
    <div class="spinner" style="
      width:22px; height:22px; border:3px solid #ddd; border-top-color:#555; border-radius:50%;
      animation:spin 0.8s linear infinite;"></div>
    <div id="busyText">Deleting extension…</div>
  </div>
</div>

<style>
@keyframes spin { to { transform: rotate(360deg); } }
</style>

<script>
(function () {
  const overlay = document.getElementById('busyOverlay');
  const text = document.getElementById('busyText');

  function showOverlay(msg) {
    if (msg) text.textContent = msg;
    overlay.style.display = 'flex';
    // Reduce accidental clicks while navigating away
    document.body.setAttribute('aria-busy', 'true');
  }

  // Attach to all delete links
  document.querySelectorAll('.delete-link').forEach(function (a) {
    a.addEventListener('click', function (e) {
      e.preventDefault();
      const href = a.getAttribute('href');
      const ext = new URL(href, window.location.origin).searchParams.get('number') || '';
      const ok = confirm(`Delete extension ${ext}?`);
      if (!ok) return;

      showOverlay(`Deleting extension ${ext}…`);
      // Let the server handle deletion as before; we simply navigate now.
      // The overlay stays visible during the navigation.
      window.location.href = href;
    });
  });
})();
</script>
{{end}}
